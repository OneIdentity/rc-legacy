#/********************************************************************
#* Copyright (c) 2005 Quest Software, Inc.
#* All rights reserved.
#*
#* Author:  Seth Ellsworth
#*
#* Company: Quest Software, Inc.
#*
#* Purpose: Makefile for DB2 8.2 security plug-in that provides
#*          PAM 32/64 bit authentication.
#*
#* Legal:   This script is provided under the terms of the
#*          "Vintela Resouce Central License" avaliable in
#*          the included LICENSE file.
#********************************************************************/

# The compile options were made for gcc
VERSION = @VERSION@
CC = @CC@
CC64 = @CC64@
CFLAGS = @CFLAGS@ @DEFS@ -g -DVERSION=\"$(VERSION)\"
DB2PATH = $(HOME)/sqllib
INCLUDES = -I/opt/IBM/db2/V8.1/include -I.
LDFLAGS = @LDFLAGS@
PROG = @PACKAGE_NAME@
PROG32 = $(PROG)32
PROG64 = $(PROG)64
MAKE = @MAKE@

@AIX_TRUE@all : $(PROG32).so.@VERSION@ $(PROG64).so.@VERSION@ lamAuth32 lamAuth64 pamAuth32 pamAuth64
@AIX_FALSE@@B64_TRUE@all : $(PROG32).so.@VERSION@ $(PROG64).so.@VERSION@ pamAuth32 pamAuth64
@AIX_FALSE@@B64_FALSE@all : $(PROG32).so.@VERSION@ pamAuth32

check: all test_all
@LINUX_TRUE@@LINUX_S390X_TRUE@	sudo ./test_all "./sys-auth64.so.@VERSION@"
@LINUX_TRUE@@LINUX_S390X_FALSE@	sudo ./test_all "./sys-auth32.so.@VERSION@"
@LINUX_FALSE@	./test_all "./sys-auth32.so.@VERSION@"
    
test_all: ctest.o csuite.o test_all.o all
@HPUX_TRUE@	$(CC) -o test_all test_all.o ctest.o csuite.o log32.o vsyslog32.o -ldld
@LINUX_S390X_TRUE@@HPUX_FALSE@	$(CC64) -o test_all test_all.o ctest.o csuite.o log64.o vsyslog64.o -ldl 
@LINUX_S390X_FALSE@@HPUX_FALSE@	$(CC) -o test_all test_all.o ctest.o csuite.o log32.o vsyslog32.o -ldl 

test_all.o: test_all.c
@LINUX_S390X_TRUE@	$(CC64) $(CFLAGS) $(INCLUDES) -o test_all.o -c test_all.c -g
@LINUX_S390X_FALSE@	$(CC) $(CFLAGS) $(INCLUDES) -o test_all.o -c test_all.c -g
	
    
ctest.o: ctest.h ctest.c bool.h
@LINUX_S390X_TRUE@	$(CC64) -c ctest.c -o ctest.o -g
@LINUX_S390X_FALSE@	$(CC) -c ctest.c -o ctest.o -g

csuite.o: ctest.h ctest.c bool.h csuite.c csuite.h
@LINUX_S390X_TRUE@	$(CC64) -c csuite.c -o csuite.o -g
@LINUX_S390X_FALSE@	$(CC) -c csuite.c -o csuite.o -g

clean:
	rm -f *.o *.so.@VERSION@ pamAuth32 pamAuth64 lamAuth32 lamAuth64 test/*.o test_all

distclean: clean
	rm -rf config.h config.log config.status Makefile upgrade.sh install.sh install DB2*

$(PROG32).so.@VERSION@: $(PROG32).o log32.o
	$(CC) $(LDFLAGS) -o $(PROG32).so.@VERSION@ $(PROG32).o vsyslog32.o log32.o

$(PROG32).o: $(PROG).c
	$(CC) $(CFLAGS) $(INCLUDES) -o $(PROG32).o -c $(PROG).c

$(PROG64).so.@VERSION@: $(PROG64).o log64.o
	$(CC64) $(LDFLAGS) -o $(PROG64).so.@VERSION@ $(PROG64).o vsyslog64.o log64.o

$(PROG64).o: $(PROG).c
	$(CC64) $(CFLAGS) $(INCLUDES) -o $(PROG64).o -c $(PROG).c 

pamAuth32: pamAuth32.o log32.o
	$(CC) pamAuth32.o -o pamAuth32 -lpam log32.o vsyslog32.o

pamAuth64: pamAuth64.o log64.o
	$(CC64) pamAuth64.o -o pamAuth64 -lpam log64.o vsyslog64.o

pamAuth32.o: pamAuth.c
	$(CC) $(CFLAGS) $(INCLUDES)  -c pamAuth.c -o pamAuth32.o

pamAuth64.o: pamAuth.c
	$(CC64) $(CFLAGS) $(INCLUDES) -c pamAuth.c -o pamAuth64.o

lamAuth32: lamAuth32.o
	$(CC) lamAuth32.o -o lamAuth32 vsyslog32.o log32.o

lamAuth64: lamAuth64.o
	$(CC64) lamAuth64.o -o lamAuth64 vsyslog64.o log64.o

lamAuth32.o: lamAuth.c
	$(CC) $(CFLAGS) $(INCLUDES) -c lamAuth.c -o lamAuth32.o

lamAuth64.o: lamAuth.c
	$(CC64) $(CFLAGS) $(INCLUDES) -c lamAuth.c -o lamAuth64.o

log32.o: log.c log.h vsyslog32.o
	$(CC) $(CFLAGS) $(INCLUDES) -c log.c -o log32.o

log64.o: log.c log.h vsyslog64.o
	$(CC64) $(CFLAGS) $(INCLUDES) -c log.c -o log64.o

vsyslog32.o: vsyslog.c vsyslog.h
	$(CC) $(CFLAGS) $(INCLUDES) -c vsyslog.c -o vsyslog32.o

vsyslog64.o: vsyslog.c vsyslog.h
	$(CC64) $(CFLAGS) $(INCLUDES) -c vsyslog.c -o vsyslog64.o

bin_dist: all test_all
	@rm -rf DB2_sys-auth
	@mkdir DB2_sys-auth
@AIX_TRUE@	@cp sys-auth32.so.@VERSION@ sys-auth64.so.@VERSION@ upgrade.sh install.sh INSTALL README LICENSE pamAuth32 pamAuth64 lamAuth32 lamAuth64 NEWS AUTHORS TESTING ChangeLog pam.conf.aix test_all test.conf Troubleshooting DB2_sys-auth/ 
@AIX_FALSE@@B64_TRUE@	@cp sys-auth32.so.@VERSION@ sys-auth64.so.@VERSION@ upgrade.sh install.sh INSTALL LICENSE README pamAuth32 pamAuth64 NEWS AUTHORS TESTING ChangeLog pam.conf.aix test_all test.conf Troubleshooting DB2_sys-auth/
@AIX_FALSE@@B64_FALSE@	@cp sys-auth32.so.@VERSION@ upgrade.sh install.sh INSTALL README LICENSE pamAuth32 NEWS AUTHORS TESTING ChangeLog pam.conf.aix test_all test.conf Troubleshooting DB2_sys-auth/
	@tar -cvf DB2_sys-auth_@OS@.tar DB2_sys-auth/*
	@rm -rf DB2_sys-auth
	@gzip DB2_sys-auth_@OS@.tar


src_dist: all
	@rm -rf DB2_sys-auth
	@mkdir DB2_sys-auth
	@cp configure config.h.in log.h log.c vsyslog.c vsyslog.h sys-auth.c upgrade.sh.in install.sh.in Makefile.in INSTALL README LICENSE pamAuth.c lamAuth.c NEWS AUTHORS TESTING ChangeLog pam.conf.aix ctest.c ctest.h csuite.c csuite.h test_all.c test.conf bool.h Troubleshooting DB2_sys-auth/ 
	@tar -cvf DB2_sys-auth_src.tar DB2_sys-auth/*
	@rm -rf DB2_sys-auth
	@gzip DB2_sys-auth_src.tar


dist: bin_dist src_dist

install: all
	@echo 
	@echo 
	@echo "Please run './install.sh <instance name> [LAM]'"
	@echo 
	@echo 

build: 
	@./buildall.exp
