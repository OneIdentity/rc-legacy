#/********************************************************************
#* Copyright (c) 2005 Quest Software, Inc.
#* All rights reserved.
#*
#* Author:  Seth Ellsworth
#*
#* Company: Quest Software, Inc.
#*
#* Purpose: Makefile for DB2 8.2 security plug-in that provides
#*          PAM 32/64 bit authentication.
#*
#* Legal:   This script is provided under the terms of the
#*          "Resouce Central License" avaliable at
#*          http://rc.vintela.com/topics/db2_sys-auth/license.php
#*          or in the included LICENSE file.
#********************************************************************/

# The compile options were made for gcc
VERSION = @VERSION@
CC = @CC@
CC64 = @CC64@
CFLAGS = @CFLAGS@ @DEFS@ -g -DVERSION=\"$(VERSION)\"
INCLUDES = -I/opt/IBM/db2/V8.1/include -I.
LDFLAGS = @LDFLAGS@
DLFLAG = @DLFLAG@
PROG = @PACKAGE_NAME@
PROG32 = $(PROG)32
PROG64 = $(PROG)64
MAKE = @MAKE@
LAM = lamAuth32 lamAuth64 db2dassecLam64 db2dassecLam32
PAM32 = pamAuth32 db2dassecPam32
PAM64 = pamAuth64 db2dassecPam64
PAMALL = $(PAM32) $(PAM64)
CHECKS = @CHECKS@    
@DO32@@DO64@TESTS = test_all32 test_all64
@NO32@@DO64@TESTS = test_all64
@DO32@@NO64@TESTS = test_all32 
TEST32 = ctest32.o csuite32.o test_all32.o log32.o vsyslog32.o
TEST64 = ctest64.o csuite64.o test_all64.o log64.o vsyslog64.o

@DO32@@DO64@@DOLAM@all : $(PROG32).so.@VERSION@ $(PROG64).so.@VERSION@ $(PAMALL) $(LAM)
@DO32@@DO64@@NOLAM@all : $(PROG32).so.@VERSION@ $(PROG64).so.@VERSION@ $(PAMALL)
@DO32@@NO64@all: $(PROG32).so.@VERSION@ $(PAM32)
@NO32@@DO64@all: $(PROG64).so.@VERSION@ $(PAM64)

check: $(TESTS) $(CHECKS)

check32sudo: test_all32
	sudo ./test_all32 "./sys-auth32.so.@VERSION@"

check64sudo: test_all64
	sudo ./test_all64 "./sys-auth64.so.@VERSION@"

check32: test_all32
	./test_all32 "./sys-auth32.so.@VERSION@"

check64: test_all64
	./test_all64 "./sys-auth64.so.@VERSION@"

test_all64: $(TEST64) $(PROG64).so.@VERSION@
	$(CC64) -o test_all64 $(TEST64) $(DLFLAG)

test_all64.o: test_all.c
	$(CC64) $(CFLAGS) $(INCLUDES) -o test_all64.o -c test_all.c -g
    
test_all32: $(TEST32) $(PROG32).so.@VERSION@
	$(CC) -o test_all32 $(TEST32) $(DLFLAG)

test_all32.o: test_all.c
	$(CC) $(CFLAGS) $(INCLUDES) -o test_all32.o -c test_all.c -g
    
ctest64.o: ctest.h ctest.c bool.h
	$(CC64) $(CFLAGS) -c ctest.c -o ctest64.o -g

csuite64.o: ctest.h ctest.c bool.h csuite.c csuite.h
	$(CC64) $(CFLAGS) -c csuite.c -o csuite64.o -g

ctest32.o: ctest.h ctest.c bool.h
	$(CC) $(CFLAGS) -c ctest.c -o ctest32.o -g

csuite32.o: ctest.h ctest.c bool.h csuite.c csuite.h
	$(CC) $(CFLAGS) -c csuite.c -o csuite32.o -g

clean:
	rm -f *.o *.so.@VERSION@ $(LAM) $(PAMALL) test/*.o $(TESTS)

distclean: clean
	rm -rf config.h config.log config.status Makefile upgrade.sh install.sh install DB2* Troubleshooting autom4te.cache install_das.sh

$(PROG32).so.@VERSION@: $(PROG32).o log32.o
	$(CC) $(LDFLAGS) -o $(PROG32).so.@VERSION@ $(PROG32).o vsyslog32.o log32.o

$(PROG32).o: $(PROG).c
	$(CC) $(CFLAGS) $(INCLUDES) -o $(PROG32).o -c $(PROG).c

$(PROG64).so.@VERSION@: $(PROG64).o log64.o
	$(CC64) $(LDFLAGS) -o $(PROG64).so.@VERSION@ $(PROG64).o vsyslog64.o log64.o

$(PROG64).o: $(PROG).c
	$(CC64) $(CFLAGS) $(INCLUDES) -o $(PROG64).o -c $(PROG).c 

pamAuth32: pamAuth32.o log32.o
	$(CC) pamAuth32.o -o pamAuth32 -lpam log32.o vsyslog32.o

pamAuth64: pamAuth64.o log64.o
	$(CC64) pamAuth64.o -o pamAuth64 -lpam log64.o vsyslog64.o

pamAuth32.o: pamAuth.c
	$(CC) $(CFLAGS) $(INCLUDES)  -c pamAuth.c -o pamAuth32.o

pamAuth64.o: pamAuth.c
	$(CC64) $(CFLAGS) $(INCLUDES) -c pamAuth.c -o pamAuth64.o

lamAuth32: lamAuth32.o
	$(CC) lamAuth32.o -o lamAuth32 vsyslog32.o log32.o

lamAuth64: lamAuth64.o
	$(CC64) lamAuth64.o -o lamAuth64 vsyslog64.o log64.o

lamAuth32.o: lamAuth.c
	$(CC) $(CFLAGS) $(INCLUDES) -c lamAuth.c -o lamAuth32.o

lamAuth64.o: lamAuth.c
	$(CC64) $(CFLAGS) $(INCLUDES) -c lamAuth.c -o lamAuth64.o

db2dassecLam32: db2dassecLam32.o
	$(CC) db2dassecLam32.o -o db2dassecLam32

db2dassecLam64: db2dassecLam64.o
	$(CC64) $(LDFLAGS) db2dassecLam64.o -o db2dassecLam64

db2dassecLam32.o: db2dassecLam.c
	$(CC) $(CFLAGS) $(INCLUDES)  -c db2dassecLam.c -o db2dassecLam32.o

db2dassecLam64.o: db2dassecLam.c
	$(CC64) $(CFLAGS) $(INCLUDES) -c db2dassecLam.c -o db2dassecLam64.o

db2dassecPam32: db2dassecPam32.o
	$(CC) db2dassecPam32.o -o db2dassecPam32 -lpam

db2dassecPam64: db2dassecPam64.o
	$(CC64) db2dassecPam64.o -o db2dassecPam64 -lpam

db2dassecPam32.o: db2dassecPam.c
	$(CC) $(CFLAGS) $(INCLUDES)  -c db2dassecPam.c -o db2dassecPam32.o

db2dassecPam64.o: db2dassecPam.c
	$(CC64) $(CFLAGS) $(INCLUDES) -c db2dassecPam.c -o db2dassecPam64.o

log32.o: log.c log.h vsyslog32.o
	$(CC) $(CFLAGS) $(INCLUDES) -c log.c -o log32.o

log64.o: log.c log.h vsyslog64.o
	$(CC64) $(CFLAGS) $(INCLUDES) -c log.c -o log64.o

vsyslog32.o: vsyslog.c vsyslog.h
	$(CC) $(CFLAGS) $(INCLUDES) -c vsyslog.c -o vsyslog32.o

vsyslog64.o: vsyslog.c vsyslog.h
	$(CC64) $(CFLAGS) $(INCLUDES) -c vsyslog.c -o vsyslog64.o

bin_dist: all $(TESTS)
	@rm -rf DB2_sys-auth
	@mkdir DB2_sys-auth
	@chmod +x upgrade.sh install.sh install_das.sh
@DOLAM@	@cp sys-auth32.so.@VERSION@ sys-auth64.so.@VERSION@ upgrade.sh install.sh install_das.sh INSTALL README LICENSE $(PAMALL) $(LAM) NEWS AUTHORS TESTING ChangeLog pam.conf.aix $(TESTS) test.conf Troubleshooting DB2_sys-auth/ 
@NOLAM@@DO32@@DO64@	@cp sys-auth32.so.@VERSION@ sys-auth64.so.@VERSION@ upgrade.sh install.sh install_das.sh INSTALL LICENSE README $(PAMALL) NEWS AUTHORS TESTING ChangeLog pam.conf.aix $(TESTS) test.conf Troubleshooting DB2_sys-auth/
@NOLAM@@NO64@	@cp sys-auth32.so.@VERSION@ upgrade.sh install.sh install_das.sh INSTALL README LICENSE $(PAM32) NEWS AUTHORS TESTING ChangeLog pam.conf.aix $(TESTS) test.conf Troubleshooting DB2_sys-auth/
@NOLAM@@NO32@	@cp sys-auth64.so.@VERSION@ upgrade.sh install.sh install_das.sh INSTALL README LICENSE $(PAM64) NEWS AUTHORS TESTING ChangeLog pam.conf.aix $(TESTS) test.conf Troubleshooting DB2_sys-auth/
	@tar -cvf DB2_sys-auth_@PLATFORM@.tar DB2_sys-auth/*
	@rm -rf DB2_sys-auth
	@gzip DB2_sys-auth_@PLATFORM@.tar


src_dist: all
	@rm -rf DB2_sys-auth
	@mkdir DB2_sys-auth
	@cp configure config.h.in log.h log.c vsyslog.c vsyslog.h sys-auth.c upgrade.sh.in install.sh.in Makefile.in INSTALL README LICENSE pamAuth.c lamAuth.c NEWS AUTHORS TESTING ChangeLog pam.conf.aix ctest.c ctest.h csuite.c csuite.h test_all.c test.conf bool.h Troubleshooting db2dassecLam.c db2dassecPam.c DB2_sys-auth/ 
	@tar -cvf DB2_sys-auth_src.tar DB2_sys-auth/*
	@rm -rf DB2_sys-auth
	@gzip DB2_sys-auth_src.tar


dist: bin_dist src_dist

install: all
	@echo 
	@echo 
	@echo "Please run './install.sh <instance name> [LAM]'"
	@echo 
	@echo 

build: 
	@./make_all.exp
