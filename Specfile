# (c) 2006 Quest Software, Inc. All rights reserved.
%define _prefix /opt/quest
%define _mandir /opt/quest/man
%define _sysconfdir /etc%{_prefix}
%define name vasidmapd
%define vendortag Quest-VRC

Summary:  VAS idmap daemon and utilities
Vendor:   Quest Software
Packager: Vinteal Resource Central Team
Name:     vasidmapd
Version:  0.9.7
Release:  1
License:  Quest Software - All Rights Reserved
Group:    System Environment/Daemons
URL:      http://rc.vintela.com


Source:   vasidmapd-%{version}.tar.gz

Requires: quest-samba >= 3.0.23 vasclnts >= 3.0.2
BuildRoot: %{_tmppath}/%{name}-%{version}-root
BuildRequires: make, gcc, vasdev >= 3.0.2
Provides: vasidmapd = %{version}

BuildRoot: %{_tmppath}/%{name}-%{version}-root
Prefix: %{_prefix}

%description
This package uses Quest's Vintela Authentication Services (VAS3) to 
provide an external idmap server for Samba


%prep
%setup -q -n vasidmapd-%{version} 

%build

./configure

make

%install
# Clean up in case there is trash left from a previous build
[ $RPM_BUILD_ROOT = "/" ] && (echo "your buildroot is /" && exit 0) || rm -rf $RPM_BUILD_ROOT

# Create the target build directory hierarchy
mkdir -p $RPM_BUILD_ROOT%{_prefix}/{bin,sbin}
mkdir -p $RPM_BUILD_ROOT%{_sysconfdir}/rc.d/init.d

install -m755 vasidmapd ${RPM_BUILD_ROOT}/%{_prefix}/sbin
install -m755 vasidmap ${RPM_BUILD_ROOT}/%{_prefix}/bin
install -m755 vasidmap-config ${RPM_BUILD_ROOT}/%{_prefix}/bin
install -m755 vasidmap-preload ${RPM_BUILD_ROOT}/%{_prefix}/bin
install -m755 vasidmapd-rh.init $RPM_BUILD_ROOT%{_sysconfdir}/rc.d/init.d
install -m755 vasidmapd-suse.init $RPM_BUILD_ROOT%{_sysconfdir}/rc.d/init.d

%clean
rm -rf $RPM_BUILD_ROOT

%post
if [ -f /etc/redhat-release ]; then
	ln -s %{_sysconfdir}/rc.d/init.d/vasidmapd-rh.init /etc/init.d/vasidmapd
	/sbin/chkconfig --add vasidmapd
else
  SUSE=`ls /etc/SuSE-release /etc/UnitedLinux-release /etc/sles-release 2>/dev/null | grep release > /dev/null && echo 1 || echo 0`
  if [ $SUSE == "1" ]; then
	ln -s %{_sysconfdir}/rc.d/init.d/vasidmapd-suse.init /etc/init.d/vasidmapd
        /sbin/insserv vasidmapd
  fi
fi
# remove vasmacron from crontab (inserted by preproduction packages only)
#MAPCRON=`grep vasmapcron /etc/crontab > /dev/null && echo 1 || echo 0`
#if [ $MAPCRON != "0" ]; then
#	grep -v vasmapcron /etc/crontab > /etc/crontab.new
#	mv /etc/crontab.new /etc/crontab
#fi

# Don't run the config package on installation, in many cases this is more trouble than benefits
#/opt/quest/bin/vasidmap-config

%preun
if [ -f /etc/redhat-release ]; then
  if [ $1 = 0 ] ; then
    /sbin/chkconfig --del vasidmapd
    /sbin/service vasidmapd stop >/dev/null 2>&1
  fi
else
  SUSE=`ls /etc/SuSE-release /etc/UnitedLinux-release /etc/sles-release 2>/dev/null | grep release > /dev/null && echo 1 || echo 0`
  if [ $SUSE == "1" ]; then
        /sbin/insserv -r vasidmapd
  fi
fi
rm -f /etc/init.d/vasidmapd
exit 0

%files
%defattr(-,root,root)

%{_sbindir}/vasidmapd
%{_bindir}/vasidmap
%{_bindir}/vasidmap-config
%{_bindir}/vasidmap-preload
%{_sysconfdir}/rc.d/init.d/vasidmapd-rh.init
%{_sysconfdir}/rc.d/init.d/vasidmapd-suse.init

%changelog
* Mon Jul 24 2006 Simo Sorce <simo,sorce@quest,com>
- updated to 0.9.1

* Wed Jun 14 2006 Simo Sorce <simo,sorce@quest,com>
- Initial release

