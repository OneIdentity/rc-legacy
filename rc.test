#!/bin/sh

: ${builddir:=.}
: ${host:=127.0.0.1}
: ${port:=389}          # vastool -p option not working
: ${vastool:=/opt/quest/bin/vastool}
: ${debug:=}        # eg -d2
: ${SUDO:=sudo}

EXIT=0
desc () { DESC="$*"; }
fail () { echo "[37;41mFAILED[m [4m$DESC${*:+ ($*)}[m" >&2; EXIT=1; }
pass () { echo "[37;42mPASSED[m [4m$DESC${*:+ ($*)}[m" >&2; }
result () { test $? -eq 0 && pass || fail; }
negresult () { test $? -eq 1 && pass || fail; }
fatal () { fail; exit 1; }
required () { test $? -eq 0 && pass || fatal; }
verbose () { test -n "$debug" && echo "[4m+ $*[m" >&2; "$@"; }

expfile=${TMPDIR:-/tmp}/test.$$.expect
outfile=${TMPDIR:-/tmp}/test.$$.result
${SUDO} ${builddir}/vasidmapd -F -A $host -p $port $debug &
pid=$!
trap "rm -f $expfile $outfile; ${SUDO} kill $pid && wait" 0 # cleanup on exit

#-- used SID/GID/UIDs for testing
uid=`$vastool list users | awk -F: '{print $3; exit;}'`
uname=`$vastool nss getpwuid $uid | awk -F: '{print $1}'` 
usid=`vastool attrs -b -u $uname objectSid | awk '{print $2}'`
gid=`$vastool list groups | awk -F: '{print $3; exit;}'`
gsid=`$vastool list -s groups | awk -F: '$3 == gid {print $5; exit;}' gid=$gid`

#-- unused SID/UID/GIDs for testing
findid () {
    id=0
    while $vastool nss $1 $id 2>/dev/null >/dev/null; do
        id=`expr $id '*' 3`
        id=`expr $id '+' 7`
    done
    echo $id
}
badsid=S-1-2-3-4-5-6-7
baduid=`findid getpwuid`
badgid=`findid getgrgid`

if test -n "$debug"; then
    cat <<. >&2
        uid=    $uid
        usid=   $usid
        gid=    $gid
        gsid=   $gsid
        badsid= $badsid
        baduid= $baduid
        badgid= $badgid
.
fi

desc "start vasidmapd"
    sleep 1
    ${SUDO} kill -0 $pid 2>/dev/null
required

#-- usage "filter" ["description"] <expected-output
tryfilter () {
    desc "${2:-$1}"
    cat > $expfile
    verbose $vastool search -a -h $host -p $port "$1" > $outfile &&
    cmp $outfile $expfile
    result
    if cmp $outfile $expfile >/dev/null; then
        : ok
    else
        echo "expected:"
        sed -ne l $expfile | sed -e 's/^/	|/'  -e 's/$/|/'
        test -s $expfile || echo '	(empty)'
        echo "but got:"
        sed -ne l $outfile | sed -e 's/^/	|/'  -e 's/$/|/'
        test -s $outfile || echo '	(empty)'
    fi >&2
}
#-- usage "filter" ["description"]
tryfilterfail () {
    desc "${2:-$1, negative}"
    verbose $vastool search -a -h $host -p $port "$1" > $outfile 2>/dev/null
    negresult
}

tryfilterfail '(arbitrary=equality)'

tryfilter '(objectClass=sambaUnixIdPool)' <<.
dn: CN=VAS-Idmapper
objectClass: sambaUnixIdPool
uidNumber: 1000
gidNumber: 1000
.


tryfilter '(OBjeCTcLASS=SAmBAuNIXiDpoOl)' <<.
dn: CN=VAS-Idmapper
objectClass: sambaUnixIdPool
uidNumber: 1000
gidNumber: 1000
.

tryfilterfail '(&(a=b)(c=d)(e=f))'

tryfilter "(&(objectClass=sambaIdmapEntry)(sambaSID=$usid))" <<.
dn: CN=VAS-Idmapper
sambaSID: $usid
objectClass: sambaIdmapEntry
uidNumber: $uid
.

tryfilter "(&(objectClass=sambaIdmapEntry)(sambaSID=$gsid))" <<.
dn: CN=VAS-Idmapper
sambaSID: $gsid
objectClass: sambaIdmapEntry
gidNumber: $gid
.

tryfilter "(&(objectClass=sambaIdmapEntry)(uidNumber=$uid))" <<.
dn: CN=VAS-Idmapper
sambaSID: $usid
objectClass: sambaIdmapEntry
uidNumber: $uid
.

tryfilter "(&(objectClass=sambaIdmapEntry)(gidNumber=$gid))" <<.
dn: CN=VAS-Idmapper
sambaSID: $gsid
objectClass: sambaIdmapEntry
gidNumber: $gid
.

tryfilterfail "(&(objectClass=sambaIdmapEntry)(sambaSID=$badsid))"
tryfilterfail "(&(objectClass=sambaIdmapEntry)(uidNumber=$baduid))"
tryfilterfail "(&(objectClass=sambaIdmapEntry)(gidNumber=$badgid))"

exit $EXIT
